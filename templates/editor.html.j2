{% extends "base.html.j2" %}

{% block head %}
        <title>Audio Center</title>
        <style>
            #progress {
                background-color: blue;
                opacity: 0.5;
                border-radius: 5px;
            }
        </style>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script>
            $(document).ready(function(){
                $("#hide").click(function(){
                    $("#bar").hide();
                });
                $(".show").click(function(){
                    $("#bar").show();
                });
                $(".show2").click(function(){
                    $("#bar2").show();
                });
            });
        </script>
{% endblock %}

{% block body %}        
    <div class="">
        <div id="bgtext">
            <div class="fadein">
                <nav class="navbar navbar-expand-lg navbar-light" id="editorRibbon" style="background-color: #91d4b1;">
                    <div class="container-fluid">
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    File
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <label for="file-open" class="dropdown-item">Open</label>
                                    <form method="POST" id="file-open-form" style="display: none" enctype="multipart/form-data">
                                        <input type="hidden" name="form" value="1">
                                        <input type="file" id="file-open" name="file-open" style="display:none">
                                    </form>
                                    {%for i in out['output']%}
                                    <a class="dropdown-item" href="{{i}}" download>Download Track {{loop.index}}</a>
                                    {%endfor%}
                                    <label id="clickme" onclick="reset()" class="dropdown-item show show2 btn" data-bs-toggle="modal" data-bs-target="#saveToProfileModal">Save to Profile</label>
                                    </div>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Edit
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <a class="dropdown-item" id="deleteButton">Delete</a>
                                    <form method="POST" action="editor" id="deleteForm">
                                        <input type="hidden" name="delete" value="delete">
                                        <input type="hidden" name="totalWidth" id="totalWidth" value="0">
                                        <input type="hidden" name="startPoint" id="startPoint" value="0">
                                        <input type="hidden" name="endPoint" id="endPoint" value="0">
                                    </form>
                                    <form method="POST" action="editor">
                                        <input type="hidden" name="hide" value="hide">
                                        <input type="submit" value="Clear Audio" class="dropdown-item">
                                    </form> 
                                    </div>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <a class="dropdown-item" onclick="fillProgress(100)">Select All</a>
                                    <a class="dropdown-item" onclick="fillProgress(0)">Select None</a>
                                    </div>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Effect
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <label id="clickme" class="dropdown-item show show2 btn" onclick="showKey() " data-bs-toggle="modal" data-bs-target="#keyModal">Key Change</label>
                                    <label class="dropdown-item" onclick="showAmp()" data-bs-toggle="modal" data-bs-target="#ampModal">Amplify</label>
                                    <label class="dropdown-item" onclick="showSplit()" data-bs-toggle="modal" data-bs-target="#splitModal">Split Tracks</label>
                                    <label class="dropdown-item" onclick="showSpeed()" data-bs-toggle="modal" data-bs-target="#speedModal">Speed Change</label>
                                    <form method="POST" style="display:none">
                                        <input type="hidden" name="form" value="2">
                                        <input type="submit" name="split-tracks" id="split-tracks">
                                    </form>
                                    </div>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    View
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <a class="dropdown-item" onclick="zoom(false)">Zoom In</a>
                                    <a class="dropdown-item" onclick="zoom(true)">Zoom Out</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-keyboard="false" data-bs-backdrop="static">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-body">
                                <div id="bar" class="counter" style="">0</div>
                                <div id="bar2" class="progressbar" style="">
                                    <span class="progress"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="waveform"></div>
                <div id="spectogram"></div>
                <button class="btn btn-primary" onclick="wavesurfer.playPause()">
            <i class="glyphicon glyphicon-play"></i>
            Play
            /
            <i class="glyphicon glyphicon-pause"></i>
            Stop
        </button>
                <form method="POST" enctype="multipart/form-data" id="matthew">
                <input type="hidden" name="key-change" value="True">
                <input type="hidden" name="form" value="2">
                <div class="modal fade" id="keyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                        <div class="modal-body">
                            <div id="hiddenKeyChange">
                                <h5>Change Key</h5>
                                <input type="range" name="steps" min="-10" max="10" step="1" oninput="document.getElementById('keyValue').innerHTML = this.value">
	                            <input type="hidden" name="key-change" value="1">
                                <input id="clickmekey" class="show show2 btn btn-primary" onclick="alertModal(1.1*{{fileLength}} + 15); this.onclick=null; showBar(); hideBar(1.1*{{fileLength}} + 15); matthewRBevins()" type="submit" name="key-change" value="Change" data-bs-toggle="modal" data-bs-target="#exampleModal" data-backdrop="static" data-keyboard="false">                                
                                <br><h5>Half-Steps: <output id="keyValue">0</output></h5>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                    </div>


                    <div class="modal fade" id="speedModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                        <div class="modal-body">
                            <div id="hiddenSpeedChange">
                                <h5>Change Speed Factor</h5>
                                <input type="range" name="factorSpeed" min="0.1" max="4" step="0.1" oninput="document.getElementById('speedValue').innerHTML = this.value">
                                <input class="btn btn-primary" type="submit" name="speed-change" value="Change">
                                <br><h5>Steps: <output id="speedValue">2</output></h5>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                    </div>
                    <div class="modal fade" id="ampModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                        <div class="modal-body">
                            <div id="hiddenAmplify">
                                <h5>Change Amplify Factor</h5>
	                            <input type="hidden" name="key-change" value="False">
                                <input type="hidden" name="amplify" value="True">
                                <input type="range" name="factorAmp" min="0.1" max="4" step="0.1" oninput="document.getElementById('ampValue').innerHTML = this.value">
                                <input class="btn btn-primary" type="submit" name="amplify" value="Change">
                                <br><h5>Steps: <output id="ampValue">2</output></h5>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                    </div>
                    <div class="modal fade" id="splitModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                        <div class="modal-body">
                            <div id="hiddenSplit">
                                <h5>Split Tracks?</h5>
                                If you proceed, Audio Center will remove the lyrics and display 
                                the karaoke waveform. This action cannot be reversed.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <input class="btn btn-primary me-auto" type="submit" name="split" value="Proceed" onclick="alertModal(2*{{fileLength}} + 15); this.onclick=null; showBar(); hideBar(2*{{fileLength}} + 15)" type="submit" name="key-change" value="Change" data-bs-toggle="modal" data-bs-target="#exampleModal" data-backdrop="static" data-keyboard="false">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                    </div>
                    <div class="modal fade" id="saveToProfileModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                            <div class="modal-body">
                                <h5>Save Audio to Profile</h5>
                                <form method="POST" novalidate>
                                    <label>Post Name</label><br>
                                    <input maxlength="20" type="text" name="posttitle"><br>
                                    <label>Post Body</label><br>
                                    <textarea name="postbody"></textarea><br>
                                    {% if userData["username"] == "guest" %}
                                        <p>Since you are not logged in, clicking "Save" will make this audio available to everyone. 
                                        <a href="login">Log in</a> to create a private audio bank.</p>
                                    {% else %}
                                        <label>Private</label>
                                        <input checked type="radio" required name="vis" value="private"><br>
                                        <label>Followers Only</label>
                                        <input type="radio" required name="vis" value="followers"><br>
                                        <label>Public</label>
                                        <input type="radio" required name="vis" value="public"><br>
                                    {% endif %}
                                    <input class="btn btn-primary" type="submit" name="savepost" value="Save">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
	    let t = "NONE"; 
        var keyButton = document.getElementById("clickmekey");
        keyButton.onclick = function() {
            alertModal(1.1*{{fileLength}} + 15);
        } 
        $('#deleteButton').on('click', () => {
            $('#totalWidth').val(totalWidth)
            $('#startPoint').val(startCut)
            $('#endPoint').val(endCut)
            $('#deleteForm').submit()
        })
    	function split() {
            t = "SPLIT";
            console.log(t);
        }
        var zoomLevel = 100
        $('#file-open').on('change', () => {
            $('#file-open-form').submit()
        })
        var wavesurfer = WaveSurfer.create({
            container: "#waveform",
            waveColor: 'violet',
            progressColor: 'blue',
            backgroundColor: 'black',
            responsive: 'true',
            plugins: [
            WaveSurfer.cursor.create({
                showTime: true,
                opacity: 1,
                customShowTimeStyle: {
                    'background-color': '#000',
                    'color': '#fff',
                    'padding': '2px',
                    'font-size': '10px'
                }
            }),
            WaveSurfer.spectrogram.create({
                wavesurfer: wavesurfer,
                container: "#spectrogram",
                labels: true,
                height: 256,
            })
        ]
        });
        wavesurfer.load("{{fn}}")
        $("#hiddenKeyChange").toggle();
        $("#hiddenSpeedChange").toggle();
        $("#hiddenAmplify").toggle();

        function fillProgress(percent) {
            $('#progress').css('left', '0px');
            $('#progress').css('width', `${percent}%`);
        }
        window.setInterval(() => {
            let a = document.getElementById("spectogram")
            let b = a.getElementsByTagName("canvas")
            for (let i of b) {
                i.style.marginLeft = '-' + window.innerWidth/2 + 'px';
            }
        }, 100)

        function zoom(out) {
            if (out) {
                zoomLevel -= 50
            }
            else {
                zoomLevel += 50
            }
            wavesurfer.zoom(zoomLevel)
        }
        
        function showKey() {
	        t = "KEYCHANGE"; 
            if(!($("#hiddenKeyChange").is(":visible"))){
                $("#hiddenKeyChange").show();
            }
            if($("#hiddenSpeedChange").is(":visible")){
                $("#hiddenSpeedChange").toggle();
                }
            if($("#hiddenAmplify").is(":visible")){
                $("#hiddenAmplify").toggle();
                }
            }

        function showSpeed() {
	        t = "SPEEDCHANGE"; 
            $("#hiddenSpeedChange").show();
            if($("#hiddenKeyChange").is(":visible")){
                $("#hiddenKeyChange").toggle();
                }
            if($("#hiddenAmplify").is(":visible")){
                $("#hiddenAmplify").toggle();
                }
                
            }   

        function showSplit() {
            t = "SPLIT"; 
            closeModal(); 
            $("#hiddenSplit").show();
        }

        function reset() {
            t = "SAVE"; 
        }
            
        function showAmp() {
	        t = "AMPLIFY"; 
            $("#hiddenAmplify").show();
            if($("#hiddenKeyChange").is(":visible")){
                $("#hiddenKeyChange").toggle();
                }
            if($("#hiddenSpeedChange").is(":visible")){
                $("#hiddenSpeedChange").toggle();
                }    
                
            }

	    function closeModal(){
            $("#exampleModal").modal('hide');
            $("#ampModal").modal('hide');
            $("#speedModal").modal('hide');
            $("#keyModal").modal('hide');
            $("#splitModal").modal('hide');
        };

        $('#matthew').on("submit", (e)=>{
            if(t != "SAVE") {
                e.preventDefault();
                matthewRBevins(); 
            } 
        })
        
        function matthewRBevins() {
            console.log("Run");
            var fd = new FormData(document.getElementById("matthew"))
            fd.append("type", t); 
            $.ajax({
                type: "POST",
                url: "/editor",
                cache: false,
                data: fd,
                processData: false,
                contentType: false,
                success: function(result) {
                    closeModal()
                    console.log(result)
                    console.log("SUCCESS")
                    wavesurfer.load(result)
                    console.log("LOADED")
                },
                error: function(result) {
                    console.log(result)
                    console.log("FAILURE")
                }
            })  
        }
    </script>
{% endblock %}